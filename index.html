<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempest Weather Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .weather-card {
            background-color: white;
            border-radius: 0.75rem; /* Smaller radius */
            padding: 1rem; /* Smaller padding */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .weather-card:hover {
            transform: translateY(-4px);
        }
        .wind-dial {
            transform-origin: center;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden; width: 220px; background-color: #333; color: #fff;
            text-align: center; border-radius: 6px; padding: 5px; position: absolute;
            z-index: 1; bottom: 125%; left: 50%; margin-left: -110px;
            opacity: 0; transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .data-bar-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 8px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .data-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-out, background-color 0.5s ease;
        }
        /* Unit toggle switch */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(26px); }
        /* Custom scrollbar for hourly forecast */
        .hourly-scroll-container::-webkit-scrollbar { height: 6px; }
        .hourly-scroll-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .hourly-scroll-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        .hourly-scroll-container::-webkit-scrollbar-thumb:hover { background: #aaa; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-6 max-w-7xl">
        <header class="mb-6 flex justify-end items-center">
            <div class="flex items-center gap-4">
                 <div class="flex items-center gap-2">
                    <span class="font-medium text-sm text-gray-600">¬∞F, mph</span>
                    <label class="switch">
                        <input type="checkbox" id="unit-toggle">
                        <span class="slider"></span>
                    </label>
                    <span class="font-medium text-sm text-gray-600">¬∞C, kph</span>
                </div>
                <button id="toggle-settings-btn" class="p-2 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 focus:outline-none">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div id="credentials-section" class="bg-white p-4 rounded-xl shadow-md mb-6 hidden">
            <h2 class="text-xl font-semibold mb-3">Settings</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                <div>
                    <label for="station-id" class="block text-sm font-medium text-gray-700">Station ID 
                        <span class="tooltip text-gray-500 cursor-pointer">(?)<span class="tooltiptext">Find this on your station's page in the Tempest app settings.</span></span>
                    </label>
                    <input type="text" id="station-id" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., 12345">
                </div>
                <div>
                    <label for="api-token" class="block text-sm font-medium text-gray-700">Personal Use Token
                        <span class="tooltip text-gray-500 cursor-pointer">(?)<span class="tooltiptext">Create a token in the Tempest app: Settings > Data Authorizations.</span></span>
                    </label>
                    <input type="password" id="api-token" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Paste your token here">
                </div>
            </div>
             <div class="mt-4 flex justify-end">
                <button id="load-data-btn" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    Load Weather Data
                </button>
            </div>
        </div>

        <div id="status-message" class="text-center p-4 my-4 hidden"></div>

        <main id="dashboard-content" class="hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-semibold mb-3" id="station-name">Current Conditions</h2>
                <div class="weather-card grid grid-cols-1 md:grid-cols-3 gap-6 items-center bg-gradient-to-br from-indigo-600 to-blue-700 text-white p-4">
                    <!-- Left Column: Weather Info -->
                    <div class="flex items-center gap-6 justify-center md:justify-start">
                        <div id="current-conditions-icon" class="text-6xl"></div>
                        <div>
                            <p class="text-md" id="current-timestamp">As of: loading...</p>
                            <p class="text-6xl font-bold" id="current-temp">--¬∞</p>
                            <p class="text-xl capitalize" id="current-conditions">Loading...</p>
                        </div>
                    </div>
                    <!-- Middle Column: Solar & Lunar -->
                    <div class="flex flex-col items-center gap-2 w-full">
                        <div id="solar-graphic-container" class="w-full"></div>
                        <div id="moon-phase-container" class="flex items-center justify-center gap-2"></div>
                    </div>
                    <!-- Right Column: Temp Stats -->
                    <div class="text-center md:text-right">
                        <p>Feels Like: <span id="feels-like" class="font-semibold">--¬∞</span></p>
                        <p>High: <span id="today-high" class="font-semibold">--¬∞</span></p>
                        <p>Low: <span id="today-low" class="font-semibold">--¬∞</span></p>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Weather Cards -->
                <div class="weather-card"><div class="flex justify-between items-center text-gray-500 mb-1"><h3 class="font-semibold">Temperature</h3><i data-lucide="thermometer"></i></div><p class="text-4xl font-bold" id="temp-card">--¬∞</p><div class="data-bar-container"><div id="temp-bar" class="data-bar"></div></div></div>
                <div class="weather-card"><div class="flex justify-between items-center text-gray-500 mb-1"><h3 class="font-semibold">Humidity</h3><i data-lucide="droplets"></i></div><p class="text-4xl font-bold" id="humidity">--<span class="text-xl">%</span></p><div class="data-bar-container"><div id="humidity-bar" class="data-bar bg-blue-500"></div></div></div>
                <div class="weather-card col-span-2 md:col-span-1"><div class="flex justify-between items-center text-gray-500 mb-1"><h3 class="font-semibold">Wind</h3><i data-lucide="wind"></i></div><div class="flex items-center justify-around gap-2 text-center"><div class="relative w-20 h-20"><div id="wind-arrow" class="absolute inset-0 wind-dial"><svg viewBox="0 0 100 100" class="fill-indigo-600"><polygon points="50,0 70,80 50,60 30,80"/></svg></div></div><div><p class="text-3xl font-bold" id="wind-speed">--</p><p class="text-gray-500 text-sm" id="wind-speed-unit">mph</p><p class="text-gray-500 mt-1 text-sm" id="wind-direction-text">---</p></div></div></div>
                <div class="weather-card"><div class="flex justify-between items-center text-gray-500 mb-1"><h3 class="font-semibold">Wind Gust</h3><i data-lucide="flag-triangle-right"></i></div><p class="text-4xl font-bold" id="wind-gust">--</p><div class="data-bar-container"><div id="wind-gust-bar" class="data-bar bg-red-500"></div></div></div>
                <div class="weather-card"><div class="flex justify-between items-center text-gray-500 mb-1"><h3 class="font-semibold">Rainfall Today</h3><i data-lucide="umbrella"></i></div><p class="text-4xl font-bold" id="rain-today">--</p><div class="data-bar-container"><div id="rain-bar" class="data-bar bg-sky-500"></div></div></div>
                <div class="weather-card"><div class="flex justify-between items-center text-gray-500 mb-1"><h3 class="font-semibold">Pressure</h3><i data-lucide="gauge-circle"></i></div><p class="text-4xl font-bold" id="pressure">--</p><p class="text-gray-500 text-sm capitalize" id="pressure-trend">---</p></div>
                <div class="weather-card"><div class="flex justify-between items-center text-gray-500 mb-1"><h3 class="font-semibold">UV Index</h3><i data-lucide="sun"></i></div><p class="text-4xl font-bold" id="uv-index">--</p><p class="text-gray-500 text-sm capitalize" id="uv-description">---</p></div>
                <div class="weather-card"><div class="flex justify-between items-center text-gray-500 mb-1"><h3 class="font-semibold">Lightning</h3><i data-lucide="cloud-lightning"></i></div><p class="text-4xl font-bold" id="lightning-count">--</p><p class="text-gray-500 text-sm" id="last-lightning">--</p></div>
            </div>
            
            <div class="mt-6">
                 <h2 class="text-2xl font-semibold mb-3">Today's Hourly Forecast</h2>
                 <div class="weather-card bg-gray-50 p-2"><div id="hourly-forecast-container" class="hourly-scroll-container flex overflow-x-auto space-x-2 pb-2"></div></div>
            </div>
            <div class="mt-6">
                 <h2 class="text-2xl font-semibold mb-3">Daily Forecast</h2>
                 <div id="forecast-container" class="weather-card bg-gray-50 p-4"></div>
            </div>
            <div class="mt-6">
                 <h2 class="text-2xl font-semibold mb-3">10-Day Forecast</h2>
                 <div id="ten-day-forecast-container" class="weather-card bg-gray-50 p-4"></div>
            </div>
        </main>
    </div>

    <script>
        // --- Global State ---
        let isMetric = false;
        let lastObsData = null;
        let lastForecastData = null;
        let refreshInterval = null;

        // --- DOM Elements ---
        const stationIdInput = document.getElementById('station-id');
        const apiTokenInput = document.getElementById('api-token');
        const loadDataBtn = document.getElementById('load-data-btn');
        const toggleSettingsBtn = document.getElementById('toggle-settings-btn');
        const unitToggle = document.getElementById('unit-toggle');
        const credentialsSection = document.getElementById('credentials-section');
        const statusMessage = document.getElementById('status-message');
        const dashboardContent = document.getElementById('dashboard-content');
        
        // --- Utility Functions ---
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-blue-100', 'text-blue-700');
            statusMessage.classList.add(isError ? 'bg-red-100' : 'bg-blue-100', isError ? 'text-red-700' : 'text-blue-700');
            dashboardContent.classList.add('hidden');
        }
        function convertToCardinal(deg) { const d=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW']; return d[Math.round(deg/22.5)%16]; }
        function getUvDescription(uv) { if (uv<=2)return'Low';if(uv<=5)return'Moderate';if(uv<=7)return'High';if(uv<=10)return'Very High';return'Extreme'; }
        
        function getWeatherIcon(icon, context = 'Unknown Context') {
            const i = {'clear-day':'‚òÄÔ∏è','clear-night':'üåô','cloudy':'‚òÅÔ∏è','foggy':'üå´Ô∏è','partly-cloudy-day':'‚õÖÔ∏è','partly-cloudy-night':'‚òÅÔ∏èüåô','possibly-rainy-day':'üå¶Ô∏è','possibly-rainy-night':'üåßÔ∏è','possibly-sleet-day':'üå®Ô∏è','possibly-sleet-night':'üå®Ô∏è','possibly-snow-day':'üå®Ô∏è','possibly-snow-night':'üå®Ô∏è','rainy':'üåßÔ∏è','sleet':'üå®Ô∏è','snow':'‚ùÑÔ∏è','thunderstorm':'‚õàÔ∏è','windy':'üí®', 'possibly-thunderstorm-day': '‚õàÔ∏è'};
            if (i[icon]) {
                return i[icon];
            }
            console.warn(`Unrecognized weather icon from better_forecast API. Context: ${context}, Field: 'icon', Value: '${icon}'`);
            return '‚ùì';
        }

        function formatMinutesToTime(minutes) { const h=Math.floor(minutes/60),m=minutes%60,ampm=h>=12?'PM':'AM',hour=h%12||12; return `${hour}:${m.toString().padStart(2,'0')} ${ampm}`; }

        // --- Moon Phase Calculation ---
        function calculateMoonPhase(date) {
            const julianDate = date.getTime() / 86400000 + 2440587.5;
            const daysSinceNewMoon = new Date(2000, 0, 6);
            const newMoon = daysSinceNewMoon.getTime() / 86400000 + 2440587.5;
            const phase = (julianDate - newMoon) % 29.53058867;
            const phaseIndex = Math.floor((phase / 29.53058867) * 8 + 0.5) & 7;

            const phases = [
                { name: 'New Moon', icon: 'üåë' }, { name: 'Waxing Crescent', icon: 'üåí' },
                { name: 'First Quarter', icon: 'üåì' }, { name: 'Waxing Gibbous', icon: 'üåî' },
                { name: 'Full Moon', icon: 'üåï' }, { name: 'Waning Gibbous', icon: 'üåñ' },
                { name: 'Last Quarter', icon: 'üåó' }, { name: 'Waning Crescent', icon: 'üåò' }
            ];
            return phases[phaseIndex];
        }

        // --- Main Application Logic ---
        async function fetchWeatherData(stationId, token, isAutoRefresh = false) {
            if (!isAutoRefresh) {
                showStatus('Fetching latest weather data...', false);
                loadDataBtn.disabled = true;
                loadDataBtn.textContent = 'Loading...';
            }
            if (refreshInterval) clearInterval(refreshInterval);

            const obsUrl = `https://swd.weatherflow.com/swd/rest/observations/station/${stationId}?token=${token}`;
            const forecastUrl = `https://swd.weatherflow.com/swd/rest/better_forecast?station_id=${stationId}&token=${token}`;
            
            try {
                const [obsResponse, forecastResponse] = await Promise.all([fetch(obsUrl), fetch(forecastUrl)]);
                if (!obsResponse.ok) throw new Error(`Observations: ${(await obsResponse.json()).status_message}`);
                if (!forecastResponse.ok) throw new Error(`Forecast: ${(await forecastResponse.json()).status_message}`);

                lastObsData = await obsResponse.json();
                lastForecastData = await forecastResponse.json();

                if (!isAutoRefresh) {
                    localStorage.setItem('tempestStationId', stationId);
                    localStorage.setItem('tempestApiToken', token);
                    credentialsSection.classList.add('hidden');
                }
                updateUI();
                
                refreshInterval = setInterval(() => { fetchWeatherData(stationId, token, true); }, 10 * 60 * 1000);

            } catch (error) {
                console.error("API Error:", error);
                showStatus(`API Error: ${error.message}. Please check credentials and network.`, true);
                if (!isAutoRefresh) credentialsSection.classList.remove('hidden');
            } finally {
                 if (!isAutoRefresh) { loadDataBtn.disabled = false; loadDataBtn.textContent = 'Load Weather Data'; }
            }
        }

        function updateUI() {
            if (!lastObsData || !lastForecastData) return;
            
            statusMessage.classList.add('hidden');
            dashboardContent.classList.remove('hidden');

            const obs = lastObsData.obs[0];
            const forecast = lastForecastData.forecast;
            const currentCond = lastForecastData.current_conditions;
            
            const tempC = obs.air_temperature, temp = isMetric ? tempC : (tempC * 9/5 + 32);
            const feelsLike = isMetric ? obs.feels_like : (obs.feels_like * 9/5 + 32);
            const high = isMetric ? forecast.daily[0].air_temp_high : (forecast.daily[0].air_temp_high * 9/5 + 32);
            const low = isMetric ? forecast.daily[0].air_temp_low : (forecast.daily[0].air_temp_low * 9/5 + 32);
            const windMs = obs.wind_avg, windSpeed = isMetric ? (windMs * 3.6) : (windMs * 2.23694);
            const windGust = isMetric ? (obs.wind_gust * 3.6) : (obs.wind_gust * 2.23694);
            const windUnit = isMetric ? 'kph' : 'mph';
            const rainMm = obs.precip_accum_local_day, rain = isMetric ? rainMm : (rainMm * 0.03937), rainUnit = isMetric ? 'mm' : 'in';
            const pressureHpa = obs.barometric_pressure, pressure = isMetric ? pressureHpa : (pressureHpa * 0.02953);

            document.getElementById('station-name').textContent = `Current Conditions for ${lastForecastData.location_name}`;
            document.getElementById('current-timestamp').textContent = `As of: ${new Date(obs.timestamp * 1000).toLocaleTimeString()}`;
            document.getElementById('current-temp').textContent = `${temp.toFixed(1)}¬∞`;
            document.getElementById('current-conditions').textContent = currentCond.conditions;
            const currentIconEl = document.getElementById('current-conditions-icon');
            currentIconEl.textContent = getWeatherIcon(currentCond.icon, 'current_conditions');
            currentIconEl.title = currentCond.conditions;
            document.getElementById('feels-like').textContent = `${feelsLike.toFixed(1)}¬∞`;
            document.getElementById('today-high').textContent = `${high.toFixed(1)}¬∞`;
            document.getElementById('today-low').textContent = `${low.toFixed(1)}¬∞`;
            document.getElementById('temp-card').textContent = `${temp.toFixed(1)}¬∞`;
            document.getElementById('humidity').innerHTML = `${obs.relative_humidity.toFixed(0)}<span class="text-xl">%</span>`;
            document.getElementById('wind-arrow').style.transform = `rotate(${obs.wind_direction + 180}deg)`;
            document.getElementById('wind-speed').textContent = windSpeed.toFixed(1);
            document.getElementById('wind-speed-unit').textContent = windUnit;
            document.getElementById('wind-direction-text').textContent = `from ${convertToCardinal(obs.wind_direction)}`;
            document.getElementById('wind-gust').textContent = `${windGust.toFixed(1)}`;
            document.getElementById('rain-today').textContent = `${rain.toFixed(2)} ${rainUnit}`;
            document.getElementById('pressure').textContent = pressure.toFixed(isMetric ? 1 : 2);
            document.getElementById('pressure-trend').textContent = obs.pressure_trend;
            document.getElementById('uv-index').textContent = obs.uv.toFixed(1);
            document.getElementById('uv-description').textContent = getUvDescription(obs.uv);
            document.getElementById('lightning-count').textContent = obs.lightning_strike_count_last_3hr;
            document.getElementById('last-lightning').textContent = obs.lightning_strike_last_dist > 0 ? `${obs.lightning_strike_last_dist} km away` : 'None recently';

            const tempScaleVal = (tempC - (-10)) / (40 - (-10));
            const tempBar = document.getElementById('temp-bar');
            tempBar.style.width = `${Math.max(0, Math.min(1, tempScaleVal)) * 100}%`;
            if (tempC <= 0) tempBar.style.backgroundColor = '#3b82f6'; else if (tempC <= 22) tempBar.style.backgroundColor = '#22c55e'; else tempBar.style.backgroundColor = '#ef4444';
            document.getElementById('humidity-bar').style.width = `${obs.relative_humidity}%`;
            document.getElementById('wind-gust-bar').style.width = `${Math.max(0, Math.min(1, (isMetric ? windGust / 96 : windGust / 60))) * 100}%`;
            document.getElementById('rain-bar').style.width = `${Math.max(0, Math.min(1, (isMetric ? rain / 50 : rain / 2))) * 100}%`;
            
            const moonPhase = calculateMoonPhase(new Date(obs.timestamp * 1000));
            document.getElementById('moon-phase-container').innerHTML = `<span class="text-3xl" title="${moonPhase.name}">${moonPhase.icon}</span><span class="text-sm font-medium">${moonPhase.name}</span>`;
            createSolarGraphic(forecast.daily[0].sunrise, forecast.daily[0].sunset, obs.timestamp);
            renderDailyForecast(forecast);
            renderHourlyForecast(forecast);
            renderTenDayForecast(forecast);
            lucide.createIcons();
        }

        function createSolarGraphic(sunrise_ts, sunset_ts, current_ts) {
            const container = document.getElementById('solar-graphic-container');
            if (!container) return;
            const width = container.clientWidth;
            if (width === 0) return;

            const sunriseDate = new Date(sunrise_ts * 1000), sunsetDate = new Date(sunset_ts * 1000), currentDate = new Date(current_ts * 1000);
            const SUNRISE_MIN = sunriseDate.getHours() * 60 + sunriseDate.getMinutes();
            const SUNSET_MIN = sunsetDate.getHours() * 60 + sunsetDate.getMinutes();
            const CURRENT_TIME_MIN = currentDate.getHours() * 60 + currentDate.getMinutes();
            const TOTAL_MINUTES = 1440;

            const height = 150, horizonY = height * 0.6, amplitude = height * 0.4;
            const timeToX = (minute) => (minute / TOTAL_MINUTES) * width;

            const daylightDuration = SUNSET_MIN - SUNRISE_MIN, nightDuration = TOTAL_MINUTES - daylightDuration;
            const getSunY = (minute) => {
                if (minute >= SUNRISE_MIN && minute <= SUNSET_MIN) {
                    return horizonY - Math.sin(((minute - SUNRISE_MIN) / daylightDuration) * Math.PI) * amplitude;
                } else {
                    let timeIntoNight = (minute > SUNSET_MIN) ? minute - SUNSET_MIN : minute + (TOTAL_MINUTES - SUNSET_MIN);
                    return horizonY + Math.sin((timeIntoNight / nightDuration) * Math.PI) * amplitude;
                }
            };
            
            let sunPathPoints = '', dayFillPathD = `M ${timeToX(SUNRISE_MIN)},${horizonY} `, nightFillPath1_D = `M ${timeToX(SUNSET_MIN)},${horizonY} `, nightFillPath2_D = `M ${timeToX(0)},${horizonY} `;
            for (let min = 0; min <= TOTAL_MINUTES; min += 5) {
                const x = timeToX(min), y = getSunY(min);
                sunPathPoints += `${x},${y} `;
                if (min >= SUNRISE_MIN && min <= SUNSET_MIN) dayFillPathD += `L ${x},${y} `;
                if (min >= SUNSET_MIN) nightFillPath1_D += `L ${x},${y} `;
                if (min <= SUNRISE_MIN) nightFillPath2_D += `L ${x},${y} `;
            }
            dayFillPathD += `L ${timeToX(SUNSET_MIN)},${horizonY} Z`;
            nightFillPath1_D += `L ${timeToX(TOTAL_MINUTES)},${horizonY} Z`;
            nightFillPath2_D += `L ${timeToX(SUNRISE_MIN)},${horizonY} Z`;

            const tickTimes = [{m:0,l:'0'},{m:360,l:'6'},{m:720,l:'12'},{m:1080,l:'6'},{m:1440,l:'0'}];
            let tickMarksHtml = '';
            tickTimes.forEach((tick, index) => {
                const x = timeToX(tick.m);
                let anchor = (index === 0) ? 'start' : (index === tickTimes.length - 1) ? 'end' : 'middle';
                tickMarksHtml += `<line x1="${x}" y1="${horizonY}" x2="${x}" y2="${horizonY+5}" stroke="white" stroke-width="1"/><text x="${x}" y="${horizonY+18}" text-anchor="${anchor}" fill="white" font-size="0.7rem">${tick.l}</text>`;
            });

            const sunX = timeToX(CURRENT_TIME_MIN), sunY = getSunY(CURRENT_TIME_MIN);
            container.innerHTML = `<svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}"><path d="${nightFillPath1_D}" fill="#000"/><path d="${nightFillPath2_D}" fill="#000"/><path d="${dayFillPathD}" fill="#4a90e2"/><line x1="0" y1="${horizonY}" x2="${width}" y2="${horizonY}" stroke="white" stroke-width="1.5"/>${tickMarksHtml}<path d="M ${sunPathPoints.trim()}" fill="none" stroke="#fbbf24" stroke-width="2" stroke-dasharray="4 4"/><circle cx="${timeToX(SUNRISE_MIN)}" cy="${horizonY}" r="4" fill="white"/><text x="${timeToX(SUNRISE_MIN)-5}" y="${horizonY-8}" text-anchor="end" fill="white" font-size="0.75rem">${formatMinutesToTime(SUNRISE_MIN)}</text><circle cx="${timeToX(SUNSET_MIN)}" cy="${horizonY}" r="4" fill="white"/><text x="${timeToX(SUNSET_MIN)+5}" y="${horizonY-8}" text-anchor="start" fill="white" font-size="0.75rem">${formatMinutesToTime(SUNSET_MIN)}</text><text x="${sunX}" y="${sunY}" font-size="24" text-anchor="middle" dominant-baseline="middle">‚òÄÔ∏è</text></svg>`;
        }
        
        // --- Forecast Rendering ---
        let TEMP_SCALE_MIN_C, TEMP_SCALE_MAX_C, TEMP_SCALE_RANGE;
        function getTempBarPosition(lowC) { const p = (lowC - TEMP_SCALE_MIN_C) / TEMP_SCALE_RANGE * 100; return Math.max(0, Math.min(100, p)); }
        function getTempBarWidth(lowC, highC) { const p = (highC - lowC) / TEMP_SCALE_RANGE * 100; return Math.max(0, Math.min(100, p)); }
        
        function renderTenDayForecast(forecastData) {
            const container = document.getElementById('ten-day-forecast-container');
            container.innerHTML = '';
            const nextTenDays = forecastData.daily.slice(1);
            if (nextTenDays.length === 0) {
                container.innerHTML = '<p class="text-gray-500">10-day forecast not available.</p>';
                return;
            }
            const minLowC = Math.min(...nextTenDays.map(d => d.air_temp_low));
            const maxHighC = Math.max(...nextTenDays.map(d => d.air_temp_high));
            TEMP_SCALE_MIN_C = minLowC > -17.78 ? -17.78 : -40;
            TEMP_SCALE_MAX_C = maxHighC < 37.78 ? 37.78 : 60;
            TEMP_SCALE_RANGE = TEMP_SCALE_MAX_C - TEMP_SCALE_MIN_C;
            
            let scalePointsC = [];
            if (isMetric) {
                const s = Math.ceil(TEMP_SCALE_MIN_C / 5) * 5;
                for (let t = s; t <= TEMP_SCALE_MAX_C; t += 5) scalePointsC.push(t);
            } else {
                let pF = new Set();
                const minF = TEMP_SCALE_MIN_C * 9 / 5 + 32, maxF = TEMP_SCALE_MAX_C * 9 / 5 + 32, sF = Math.ceil(minF / 10) * 10;
                for (let tF = sF; tF <= maxF; tF += 10) if (tF !== 30) pF.add(tF);
                if (minF <= 32 && maxF >= 32) pF.add(32);
                scalePointsC = Array.from(pF).sort((a, b) => a - b).map(f => (f - 32) * 5 / 9);
            }

            let scaleHtml = '';
            scalePointsC.forEach((tC, i) => {
                const pos = getTempBarPosition(tC);
                let val = isMetric ? tC : (tC * 9 / 5 + 32);
                let txt = `${Math.round(val)}¬∞`;
                let fw = (Math.abs(tC) < .01) ? 'font-bold' : '';
                if (i === 0 || i === scalePointsC.length - 1) txt += isMetric ? 'C' : 'F';
                scaleHtml += `<div class="absolute -translate-x-1/2" style="left:${pos}%;"><span class="absolute -top-1 left-1/2 -translate-x-1/2 w-px h-1 bg-gray-400"></span><span class="text-xs ${fw}">${txt}</span></div>`;
            });
            container.innerHTML += `<div class="flex items-center text-gray-500 mb-1"><div class="w-12"></div><div class="w-10"></div><div class="w-8"></div><div class="flex-1 relative h-4 mx-2">${scaleHtml}</div><div class="w-8"></div><div class="w-16"></div></div>`;
            
            const fPos = getTempBarPosition(0);
            const fVis = TEMP_SCALE_MIN_C <= 0 && TEMP_SCALE_MAX_C >= 0;
            let fLine = fVis ? `<div class="absolute top-0 bottom-0 w-px bg-slate-500 opacity-75" style="left:${fPos}%;"></div>` : '';
            
            let rowsHtml = '';
            nextTenDays.forEach(d => {
                const dt = new Date(d.day_start_local * 1000), dN = dt.toLocaleDateString('en-US', { weekday: 'short' });
                const hC = d.air_temp_high, lC = d.air_temp_low;
                const h = isMetric ? hC : (hC * 9 / 5 + 32), l = isMetric ? lC : (lC * 9 / 5 + 32);
                const bL = getTempBarPosition(lC), bW = getTempBarWidth(lC, hC);
                rowsHtml += `<div class="flex items-center justify-between text-sm py-1"><p class="font-semibold w-12 text-gray-700">${dN}</p><p class="text-2xl w-10 text-center" title="${d.conditions}">${getWeatherIcon(d.icon, `10-day forecast for ${dN}`)}</p><p class="text-gray-500 w-8 text-right font-medium">${l.toFixed(0)}¬∞</p><div class="flex-1 bg-gray-200 rounded-full h-2 mx-2 relative"><div class="bg-gradient-to-r from-blue-400 via-yellow-400 to-red-500 h-2 rounded-full" style="margin-left:${bL}%;width:${bW}%;"></div>${fLine}</div><p class="font-bold w-8 text-left">${h.toFixed(0)}¬∞</p><div class="flex items-center text-sky-600 w-16 justify-end"><i data-lucide="umbrella" class="w-4 h-4 mr-1"></i><span class="font-medium">${d.precip_probability}%</span></div></div>`;
            });
            container.innerHTML += `<div class="space-y-1">${rowsHtml}</div>`;
            lucide.createIcons();
        }

        function renderDailyForecast(forecastData) {
            const container = document.getElementById('forecast-container');
            container.innerHTML = '';
            const tomorrow = forecastData.daily[1];
            if (!tomorrow) {
                container.innerHTML = '<p>Daily forecast not available.</p>';
                return;
            }
            const high = isMetric ? tomorrow.air_temp_high : (tomorrow.air_temp_high * 9 / 5 + 32);
            const low = isMetric ? tomorrow.air_temp_low : (tomorrow.air_temp_low * 9 / 5 + 32);
            const dayName = new Date(tomorrow.day_start_local * 1000).toLocaleDateString('en-US', { weekday: 'long' });
            
            const tomorrowStart = tomorrow.day_start_local, tomorrowEnd = tomorrowStart + 86400;
            const tomorrowsHours = forecastData.hourly.filter(hr => hr.time >= tomorrowStart && hr.time < tomorrowEnd);
            
            let hourlyHtml = '<p class="text-gray-500 text-sm p-4">No hourly data available for tomorrow.</p>';
            if (tomorrowsHours.length > 0) {
                hourlyHtml = tomorrowsHours.map(hr => {
                    const hourDate = new Date(hr.time * 1000);
                    const hourString = hourDate.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true }).replace(' ', '');
                    const temp = isMetric ? hr.air_temperature : (hr.air_temperature * 9 / 5 + 32);
                    return `<div class="flex flex-col items-center flex-shrink-0 text-center p-2 rounded-lg min-w-[60px]">
                                <p class="font-medium text-sm text-gray-600">${hourString}</p>
                                <p class="text-3xl my-1" title="${hr.conditions}">${getWeatherIcon(hr.icon, `Daily forecast (hourly) for ${dayName} at ${hourString}`)}</p>
                                <p class="font-bold">${temp.toFixed(0)}¬∞</p>
                                <div class="flex items-center text-sky-600 text-xs mt-1">
                                    <i data-lucide="umbrella" class="w-3 h-3 mr-0.5"></i>
                                    <span>${hr.precip_probability}%</span>
                                </div>
                            </div>`;
                }).join('');
            }

            container.innerHTML = `<div class="flex flex-col md:flex-row items-center justify-between text-center md:text-left"><div class="mb-4 md:mb-0"><h4 class="text-xl font-bold">${dayName}</h4><p class="text-gray-600 capitalize">${tomorrow.conditions}</p></div><div class="text-5xl mb-4 md:mb-0" title="${tomorrow.conditions}">${getWeatherIcon(tomorrow.icon, `Daily forecast for ${dayName}`)}</div><div class="grid grid-cols-2 gap-x-6 gap-y-1 text-md"><div class="font-semibold text-gray-500">High</div><div class="text-red-500 font-bold">${high.toFixed(0)}¬∞</div><div class="font-semibold text-gray-500">Low</div><div class="text-blue-500 font-bold">${low.toFixed(0)}¬∞</div><div class="font-semibold text-gray-500">Precip.</div><div>${tomorrow.precip_probability}%</div></div></div><div class="mt-4 border-t pt-3"><div class="hourly-scroll-container flex overflow-x-auto space-x-2 pb-2">${hourlyHtml}</div></div>`;
        }

        function renderHourlyForecast(forecastData) {
            const container = document.getElementById('hourly-forecast-container');
            container.innerHTML = '';
            const now = Date.now() / 1000;
            const next12Hours = forecastData.hourly.filter(hr => hr.time > now).slice(0, 12);
            if (next12Hours.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Hourly forecast data is not available yet.</p>';
                return;
            }
            next12Hours.forEach(hr => {
                const hourDate = new Date(hr.time * 1000);
                const hourString = hourDate.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true }).replace(' ', '');
                const temp = isMetric ? hr.air_temperature : (hr.air_temperature * 9 / 5 + 32);
                container.innerHTML += `
                    <div class="flex flex-col items-center flex-shrink-0 text-center p-2 rounded-lg min-w-[60px]">
                        <p class="font-medium text-sm text-gray-600">${hourString}</p>
                        <p class="text-3xl my-1" title="${hr.conditions}">${getWeatherIcon(hr.icon, `Today's hourly forecast at ${hourString}`)}</p>
                        <p class="font-bold">${temp.toFixed(0)}¬∞</p>
                        <div class="flex items-center text-sky-600 text-xs mt-1">
                            <i data-lucide="umbrella" class="w-3 h-3 mr-0.5"></i>
                            <span>${hr.precip_probability}%</span>
                        </div>
                    </div>`;
            });
        }

        // --- Event Listeners and Initialization ---
        loadDataBtn.addEventListener('click', () => {
            const stationId = stationIdInput.value.trim(); const token = apiTokenInput.value.trim();
            if (stationId && token) fetchWeatherData(stationId, token);
            else showStatus('Please enter both a Station ID and an API Token.', true);
        });
        toggleSettingsBtn.addEventListener('click', () => { credentialsSection.classList.toggle('hidden'); });
        unitToggle.addEventListener('change', (e) => { isMetric = e.target.checked; localStorage.setItem('tempestIsMetric', isMetric); updateUI(); });
        window.addEventListener('resize', () => { if (lastObsData && lastForecastData) updateUI(); });

        const savedStationId = localStorage.getItem('tempestStationId'), savedApiToken = localStorage.getItem('tempestApiToken');
        const savedIsMetric = localStorage.getItem('tempestIsMetric') === 'true';
        unitToggle.checked = savedIsMetric; isMetric = savedIsMetric;

        if (savedStationId && savedApiToken) {
            stationIdInput.value = savedStationId; apiTokenInput.value = savedApiToken;
            fetchWeatherData(savedStationId, savedApiToken);
        } else {
            showStatus('Please enter your Tempest credentials to load data.', false);
            dashboardContent.classList.add('hidden'); credentialsSection.classList.remove('hidden');
        }
        
        lucide.createIcons();
    </script>
</body>
</html>

